
(function(){var root=this;var AppSeeds,Seeds;if(typeof exports!=='undefined'){AppSeeds=Seeds=exports;}else{AppSeeds=Seeds=root.AppSeeds=root.Seeds={};}
AppSeeds.version='0.6.0';if(!Array.isArray){Array.isArray=function(vArg){return Object.prototype.toString.call(vArg)==="[object Array]";};}
if(!Array.prototype.indexOf){Array.prototype.indexOf=function(a,b,c){for(c=this.length,b=(c+~~b)%c;b<c&&(!(b in this)||this[b]!==a);b++);return b^c?b:-1;};}
AppSeeds.StateManager={root:'root',current:null,_states:{},context:null,create:function(options){var C=function(){};C.prototype=this;var stateManager=new C();stateManager.root='root';stateManager._states={};stateManager._actions={};stateManager.state(stateManager.root,{parent:null,context:{},defaultSubstate:null});stateManager.context=stateManager.state(stateManager.root).context;stateManager.current=stateManager.root;options=options||{};if(typeof options==='string'||Array.isArray(options)){stateManager.add(options);}else{stateManager._onInit=options.init;if(options.states){stateManager.add(options.states);}}
return stateManager;},init:function(){if(this._isFunc(this._onInit))this._onInit.call(this);return this;},_toRoot:function(stateName){var route=[];while(stateName){route.push(stateName);stateName=this.state(stateName).parent;}
return route;},state:function(stateName,val){if(val!==undefined)this._states[stateName]=val;return this._states[stateName];},children:function(stateName){var substates=[];for(var i in this._states){if(this._states.hasOwnProperty(i)&&this._states[i].parent===stateName){substates.push(i);}}
return substates;},_lca:function(startState,endState){var exits=this._toRoot(startState),entries=this._toRoot(endState);for(var i=0;i<exits.length;i++){var idx=entries.indexOf(exits[i]);if(idx!==-1){exits=exits.slice(0,i);entries=entries.slice(0,idx).reverse();break;}}
return{exits:exits,entries:entries};},_isFunc:function(f){return typeof f==='function';},_getStatePairs:function(str){var tmp=str.split('->');var parentState,childStates;switch(tmp.length){case 0:childStates=[];break;case 1:parentState=this.root;childStates=tmp[0].split(/\s+/);break;case 2:parentState=tmp[0].replace(/^\s\s*/,'').replace(/\s\s*$/,'');childStates=tmp[1].split(/\s+/);break;default:console.warn('String '+str+' is an invalid state pair and has been dropped.');childStates=[];break;}
var pairs=[],childState,defaultSubstateRegex=/^!/;for(var i=0;i<childStates.length;i++){if(childStates[i]){pairs.push([parentState,childStates[i].replace(defaultSubstateRegex,''),defaultSubstateRegex.test(childStates[i])]);}}
return pairs;},go:function(stateName){var state=this.state(stateName);if(state===undefined){console.warn('State '+stateName+' not defined');return;}
if(this.current!==stateName){var states=this._lca(this.current,stateName);var i,action;for(i=0;i<states.exits.length;i++){this.context=this.state(states.exits[i]).context;if(this._isFunc(this.context.exit)){if(this.context.exit.call(this)===false){}}}
for(i=0;i<states.entries.length;i++){this.context=this.state(states.entries[i]).context;if(this._isFunc(this.context.enter)){if(this.context.enter.call(this)===false){}}}
this.current=stateName;var defaultSubstate=this.state(this.current).defaultSubstate;if(defaultSubstate){this.go(defaultSubstate);}else{this.context=this.state(this.current).context;if(this._isFunc(this.context.stay)){this.context.stay.call(this);}}}
return this;},add:function(stateConnection){var i,parentState,childState,isDefaultSubstate;if(arguments.length>1){for(i=0;i<arguments.length;i++){this.add(arguments[i]);}}else{if(Array.isArray(stateConnection)){for(i=0;i<stateConnection.length;i++){this.add(stateConnection[i]);}}else if(typeof stateConnection==='string'){var pairs=this._getStatePairs(stateConnection);for(i=0;i<pairs.length;i++){parentState=pairs[i][0];childState=pairs[i][1];isDefaultSubstate=pairs[i][2];if(!this.state(parentState)){console.warn('State '+parentState+' is not included in the tree. State not added.');return;}
if(this.state(childState)){console.warn('State '+childState+' is already defined. New state not added.');}
this.state(childState,{context:{},defaultSubstate:null,parent:parentState});if(isDefaultSubstate){if(this.state(parentState).defaultSubstate){console.warn('State %s already has a default substate %s which will be overwritten with %s',parentState,this.state(parentState).defaultSubstate,childState);}
this.state(parentState).defaultSubstate=childState;}}}else if(typeof stateConnection==='object'){for(i in stateConnection){if(stateConnection.hasOwnProperty(i)){this.add(i+" -> "+stateConnection[i]);}}}}
return this;},act:function(){this.context=this._act(this.current,arguments);return this;},action:function(actionName){var that=this;if(!this._actions[actionName]){this._actions[actionName]=function(){return that.act.apply(that,[actionName].concat(Array.prototype.slice.call(arguments)));};}
return this._actions[actionName];},_act:function(state,args){this.context=this.state(state).context;var action=this.context[args[0]];if(this._isFunc(action)&&action.apply(this,Array.prototype.slice.call(args,1))===false)return;var parentState=this.state(state).parent;if(parentState)this._act(parentState,args);return this.context;},when:function(stateString,actions){var i;if(typeof stateString==='object'){for(i in stateString){this.when(i,stateString[i]);}}else{var states=stateString.split(/\s+/);for(i=0;i<states.length;i++){var stateName=states[i];if(stateName){var state=this.state(stateName);if(!state){console.warn('State %s doesn\'t exist. Actions not added.',stateName);return;}
if(this._isFunc(actions)){actions={stay:actions};}
if(!state.context)state.context={};for(i in actions){if(actions.hasOwnProperty(i))state.context[i]=actions[i];}}}}
return this;}};AppSeeds.PubSub={create:function(options){var C=function(){};C.prototype=this;var ps=new C();Seeds.extend(ps,options,{_pubsubEvents:{},_pubsubHappened:{}});return ps;},pub:function(eventString){var eventComponents=this._parseEventNamespace(eventString);var eventArray,i,ilen,j,jlen,args,subscriber,ret,event;for(i=0,ilen=eventComponents.length;i<ilen;i++){eventArray=this._pubsubEvents[event=eventComponents[i]]||[];args=Array.prototype.slice.call(arguments,1);for(j=0,jlen=eventArray.length;j<jlen;j++){subscriber=eventArray[j];ret=subscriber[0].apply(subscriber[1]||this,args);if(subscriber[2]&&ret!==false){this.unsub(event,subscriber[0]);}}
this._pubsubHappened[event]=args;}
return this;},_parseEventNamespace:function(event){var events=[],str='',ch;for(var i=0;i<event.length;i++){if((ch=event.charAt(i))===':')events.push(str);str+=ch;}
events.push(str);return events;},sub:function(eventStr,method,thisArg,flags){var events=eventStr.split(/\s+/),event,eventArray,i,len,oldArgs;flags=flags||{once:false,recoup:false};for(i=0,len=events.length;i<len;i++){eventArray=this._pubsubEvents[event=events[i]];if(eventArray){eventArray.push([method,thisArg,flags.once]);}else{this._pubsubEvents[event]=[[method,thisArg,flags.once]];}
if(flags.recoup&&(oldArgs=this._pubsubHappened[event])){method.apply(thisArg||this,oldArgs);}}
return this;},unsub:function(eventStr,method){var events=eventStr.split(/\s+/),event,eventArray,newEventArray,i,j;for(i=0;i<events.length;i++){eventArray=this._pubsubEvents[event=events[i]];newEventArray=[];for(j=0;j<eventArray.length;j++){if(eventArray[j][0]!==method){newEventArray.push(eventArray[j]);}}
this._pubsubEvents[event]=newEventArray;}
return this;},once:function(eventStr,method,thisArg){return this.sub(eventStr,method,thisArg,{once:true});},recoup:function(eventStr,method,thisArg){return this.sub(eventStr,method,thisArg,{recoup:true});},schedule:function(){if(!Seeds.Scheduler)return null;return Seeds.Scheduler.create.apply(AppSeeds.Scheduler,[this.pub,this].concat(Array.prototype.slice.call(arguments)));}};AppSeeds.Scheduler={create:function(callback,thisArg){var C=function(){};C.prototype=this;var schedule=new C();Seeds.extend(schedule,{callback:callback,args:Array.prototype.slice.call(arguments,2),thisArg:thisArg||this,timeout:null,interval:null,limit:null,_lastCalled:(new Date()).getTime(),_timerId:null});return schedule;},now:function(){var now=(new Date()).getTime();if(!this.limit||(now-this._lastCalled>this.limit)){this.callback.apply(this.thisArg,arguments.length?arguments:this.args);this._lastCalled=now;}
return this;},throttle:function(limit){this.limit=limit;return this;},throttled:function(callback,limit){var task=Seeds.Scheduler.create(callback).throttle(limit);return function(){task.now();};},reset:function(){this.stop();if(this.timeout){this.delay(this.timeout);}else if(this.interval){this.repeat(this.interval);}
return this;},delay:function(timeout){var that=this;this.timeout=timeout;this.interval=null;this._timerId=window.setTimeout(function(){that.now();},timeout);return this;},repeat:function(interval){var that=this;this.interval=interval;this.timeout=null;this._timerId=window.setInterval(function(){that.now();},interval);return this;},stop:function(){if(this.timeout){window.clearTimeout(this._timerId);}else if(this.interval){window.clearInterval(this._timerId);}
return this;}};AppSeeds.Permit={create:function(options){var _functions={};var _auth=[];var permit={allow:function(roleStr,originalFunction){var roles=roleStr.split(/\s+/),i,fId;if(typeof originalFunction==='function'){for(i in _functions){if(_functions.hasOwnProperty(i)&&_functions[i].func===originalFunction){fId=i;break;}}
if(!fId){_functions[fId=AppSeeds.guid()]={func:originalFunction,roles:roles};}
return function(){var f=_functions[fId];for(var i=0;i<_auth.length;i++){if(f.roles.indexOf(_auth[i])>-1){Seeds.delegate.apply(permit,['didAllow'].concat(Array.prototype.slice.call(arguments)));return f.func.apply(this,arguments);}}
Seeds.delegate.apply(permit,['didDisallow'].concat(Array.prototype.slice.call(arguments)));};}
return null;},auth:function(roles){if(Array.isArray(roles))roles=roles.join(' ');_auth=roles.split(/\s+/);return this;}};if(typeof options==='object')Seeds.extend(permit,options);return permit;}};AppSeeds.delegate=function(){var delegate=this.delegate||this;if(typeof delegate[arguments[0]]==='function'){return delegate[arguments[0]].apply(this,Array.prototype.slice.call(arguments,1));}
return true;};AppSeeds.guid=function(){var S4=function(){return(((1+Math.random())*0x10000)|0).toString(16).substring(1);};return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());};AppSeeds.extend=function(){var obj=arguments[0];for(var i=1;i<arguments.length;i++){var ext=arguments[i];if(ext){for(var j in ext){if(ext.hasOwnProperty(j))obj[j]=ext[j];}}}
return obj;};})(this);