// http://github.com/danburzo/appseeds

(function(){var AppSeeds=typeof exports!=='undefined'?exports:(this.AppSeeds=this.Seeds={});AppSeeds.version='0.4.0';if(!Array.isArray)Array.isArray=function(vArg){return Object.prototype.toString.call(vArg)==="[object Array]";};AppSeeds.StateManager={rootState:'root',_currentState:null,_allStates:{},_parentStates:{},_defaultSubstates:{},create:function(options){var C=function(){};C.prototype=this;var stateManager=new C();stateManager.rootState='root';stateManager._parentStates={};stateManager._allStates={};stateManager._defaultSubstates={};stateManager._allStates[stateManager.rootState]=stateManager.context={};stateManager._parentStates[stateManager.rootState]=null;stateManager._currentState=stateManager.rootState;options=options||{};if(typeof options==='string'||Array.isArray(options)){stateManager.add(options);}else{stateManager._onInit=options.init;if(options.states){stateManager.add(options.states);}}
return stateManager;},init:function(){if(this._isFunc(this._onInit))this._onInit.call(this);return this;},_toRoot:function(stateName){var route=[];while(stateName){route.push(stateName);stateName=this._parentStates[stateName];}
return route;},_lca:function(startState,endState){var exits=this._toRoot(startState),entries=this._toRoot(endState);for(var i=0;i<exits.length;i++){var idx=entries.indexOf(exits[i]);if(idx!==-1){exits=exits.slice(0,i);entries=entries.slice(0,idx).reverse();break;}}
return{exits:exits,entries:entries};},_isFunc:function(f){return typeof f==='function';},_getStatePairs:function(str){var tmp=str.split('->');var parentState,childStates;switch(tmp.length){case 0:childStates=[];break;case 1:parentState=this.rootState;childStates=tmp[0].split(/\s+/);break;case 2:parentState=tmp[0].trim();childStates=tmp[1].split(/\s+/);break;default:console.warn('String '+str+' is an invalid state pair and has been dropped.');childStates=[];break;}
var pairs=[],childState,defaultSubstateRegex=/^!/;for(var i=0;i<childStates.length;i++){if(childStates[i])pairs.push([parentState,childStates[i].replace(defaultSubstateRegex,''),defaultSubstateRegex.test(childStates[i])]);}
return pairs;},go:function(stateName){var state=this._allStates[stateName];if(state===undefined){console.warn('State '+stateName+' not defined');return;}
if(this._currentState!==stateName){var states=this._lca(this._currentState,stateName);var i,action;for(i=0;i<states.exits.length;i++){this.context=this._allStates[states.exits[i]];if(this._isFunc(this.context.exit)){if(this.context.exit.call(this)===false){}}}
for(i=0;i<states.entries.length;i++){this.context=this._allStates[states.entries[i]];if(this._isFunc(this.context.enter)){if(this.context.enter.call(this)===false){}}}
this._currentState=stateName;this.context=this._allStates[this._currentState];if(this._isFunc(this.context.stay)){this.context.stay.call(this);}
var defaultSubstate=this._defaultSubstates[this._currentState];if(defaultSubstate)this.go(defaultSubstate);}
return this;},add:function(stateConnection){var i,parentState,childState,isDefaultSubstate;if(typeof stateConnection==='string'){var pairs=this._getStatePairs(stateConnection);for(i=0;i<pairs.length;i++){parentState=pairs[i][0];childState=pairs[i][1];isDefaultSubstate=pairs[i][2];if(!this._allStates[parentState]){console.warn('State '+parentState+' is not included in the tree. State not added.');return;}
if(this._allStates[childState]){console.warn('State '+childState+' was already defined and will be overwritten.');}
this._allStates[childState]={};this._parentStates[childState]=parentState;if(isDefaultSubstate){if(this._defaultSubstates[parentState]){console.warn('State '+parentState+' already has a default substate '+this._defaultSubstates[parentState]+' which will be overwritten with '+childState);}
this._defaultSubstates[parentState]=childState;}}}else{for(i=0;i<stateConnection.length;i++){this.add(stateConnection[i]);}}
return this;},act:function(){this.context=this._act(this._currentState,arguments);return this;},_act:function(state,args){this.context=this._allStates[state],action=this.context[args[0]];if(this._isFunc(action)&&action.apply(this,Array.prototype.slice.call(args,1))===false)return;if(this._parentStates[state])this._act(this._parentStates[state],args);return this.context;},whenIn:function(){console.info('Deprecated: Use when() instead of whenIn()');return this.when.apply(this,arguments);},goTo:function(){console.info('Deprecated: Use go() instead of goTo()');return this.go.apply(this,arguments);},when:function(stateString,actions){var i;if(typeof stateString==='object'){for(i in stateString){this.when(i,stateString[i]);}}else{var states=stateString.split(/\s+/);for(i=0;i<states.length;i++){var stateName=states[i];if(stateName){if(!this._allStates[stateName]){console.warn('State '+stateName+' doesn\'t exist. Actions not added.');return;}
if(this._isFunc(actions)){actions={stay:actions};}
for(i in actions){if(actions.hasOwnProperty(i))this._allStates[stateName][i]=actions[i];}}}}
return this;},locate:function(){return this._currentState;}};AppSeeds.PubSub={create:function(){var C=function(){};C.prototype=this;var ps=new C();ps._pubsubEvents={};return ps;},pub:function(eventString){var eventComponents=this._parseEventNamespace(eventString);var eventArray,j,args,subscriber,ret,event;for(var i=0;i<eventComponents.length;i++){event=eventComponents[i];eventArray=this._pubsubEvents[event];if(eventArray){args=Array.prototype.slice.call(arguments,1);for(j=0;j<eventArray.length;j++){subscriber=eventArray[j];ret=subscriber[0].apply(subscriber[1]||this,args);if(subscriber[2]&&ret!==false){this.unsub(event,subscriber[0]);}}}}
return this;},_parseEventNamespace:function(event){var events=[],str='',ch;for(var i=0;i<event.length;i++){if((ch=event.charAt(i))===':')events.push(str);str+=ch;}
events.push(str);return events;},sub:function(eventStr,method,thisArg,isOnce){var events=eventStr.split(/\s+/),event,eventArray,i;for(i=0;i<events.length;i++){event=events[i];eventArray=this._pubsubEvents[event];if(eventArray){eventArray.push([method,thisArg,isOnce]);}else{this._pubsubEvents[event]=[[method,thisArg,isOnce]];}}
return this;},unsub:function(eventStr,method){var events=eventStr.split(/\s+/),event,eventArray,i;var f=function(item){return item[0]!==method;};for(i=0;i<events.length;i++){event=events[i];this._pubsubEvents[event]=this._pubsubEvents[event].filter(f);}
return this;},once:function(eventStr,method,thisArg){return this.sub(eventStr,method,thisArg,true);},schedule:function(){return AppSeeds.Scheduler.create(this.pub,arguments,this);}};AppSeeds.Scheduler={create:function(callback,args,thisArg){var C=function(){};C.prototype=this;var schedule=new C();schedule.callback=callback;schedule.args=args||[];schedule.thisArg=thisArg||this;schedule.timeout=null;schedule.interval=null;schedule._timerId=null;return schedule;},now:function(){this.callback.apply(this.thisArg,this.args);return this;},reset:function(){this.stop();if(this.timeout){this.delay(this.timeout);}else if(this.interval){this.repeat(this.interval);}
return this;},delay:function(timeout){var that=this;this.timeout=timeout;this.interval=null;this._timerId=window.setTimeout(function(){that.now();},timeout);return this;},repeat:function(interval){var that=this;this.interval=interval;this.timeout=null;this._timerId=window.setInterval(function(){that.now();},interval);return this;},stop:function(){if(this.timeout){window.clearTimeout(this._timerId);}else if(this.interval){window.clearInterval(this._timerId);}
return this;},destroy:function(){}};AppSeeds.DelegateSupport={delegate:null,del:function(name){return this.delegate&&typeof this.delegate[name]==='function'?this.delegate[name].apply(this,Array.prototype.slice.call(arguments,1)):true;}};AppSeeds.Binder={};})(this);