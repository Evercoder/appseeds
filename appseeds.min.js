
(function(){var AppSeeds=typeof exports!=='undefined'?exports:(this.AppSeeds=this.Seeds={});AppSeeds.version='0.6.0';if(!Array.isArray)Array.isArray=function(vArg){return Object.prototype.toString.call(vArg)==="[object Array]";};AppSeeds.StateManager={root:'root',current:null,_states:{},context:null,create:function(options){var C=function(){};C.prototype=this;var stateManager=new C();stateManager.root='root';stateManager._states={};stateManager.state(stateManager.root,{parent:null,context:{},defaultSubstate:null});stateManager.context=stateManager.state(stateManager.root).context;stateManager.current=stateManager.root;options=options||{};if(typeof options==='string'||Array.isArray(options)){stateManager.add(options);}else{stateManager._onInit=options.init;if(options.states){stateManager.add(options.states);}}
return stateManager;},init:function(){if(this._isFunc(this._onInit))this._onInit.call(this);return this;},_toRoot:function(stateName){var route=[];while(stateName){route.push(stateName);stateName=this.state(stateName).parent;}
return route;},state:function(stateName,val){if(val!==undefined)this._states[stateName]=val;return this._states[stateName];},children:function(stateName){var substates=[];for(var i in this._states){if(this._states.hasOwnProperty(i)&&this._states[i].parent===stateName){substates.push(i);}}
return substates;},_lca:function(startState,endState){var exits=this._toRoot(startState),entries=this._toRoot(endState);for(var i=0;i<exits.length;i++){var idx=entries.indexOf(exits[i]);if(idx!==-1){exits=exits.slice(0,i);entries=entries.slice(0,idx).reverse();break;}}
return{exits:exits,entries:entries};},_isFunc:function(f){return typeof f==='function';},_getStatePairs:function(str){var tmp=str.split('->');var parentState,childStates;switch(tmp.length){case 0:childStates=[];break;case 1:parentState=this.root;childStates=tmp[0].split(/\s+/);break;case 2:parentState=tmp[0].trim();childStates=tmp[1].split(/\s+/);break;default:console.warn('String '+str+' is an invalid state pair and has been dropped.');childStates=[];break;}
var pairs=[],childState,defaultSubstateRegex=/^!/;for(var i=0;i<childStates.length;i++){if(childStates[i])pairs.push([parentState,childStates[i].replace(defaultSubstateRegex,''),defaultSubstateRegex.test(childStates[i])]);}
return pairs;},go:function(stateName){var state=this.state(stateName);if(state===undefined){console.warn('State '+stateName+' not defined');return;}
if(this.current!==stateName){var states=this._lca(this.current,stateName);var i,action;for(i=0;i<states.exits.length;i++){this.context=this.state(states.exits[i]).context;if(this._isFunc(this.context.exit)){if(this.context.exit.call(this)===false){}}}
for(i=0;i<states.entries.length;i++){this.context=this.state(states.entries[i]).context;if(this._isFunc(this.context.enter)){if(this.context.enter.call(this)===false){}}}
this.current=stateName;this.context=this.state(this.current).context;if(this._isFunc(this.context.stay)){this.context.stay.call(this);}
var defaultSubstate=this.state(this.current).defaultSubstate;if(defaultSubstate)this.go(defaultSubstate);}
return this;},add:function(stateConnection){var i,parentState,childState,isDefaultSubstate;if(arguments.length>1){for(i=0;i<arguments.length;i++){this.add(arguments[i]);}}else{if(Array.isArray(stateConnection)){for(i=0;i<stateConnection.length;i++){this.add(stateConnection[i]);}}else if(typeof stateConnection==='string'){var pairs=this._getStatePairs(stateConnection);for(i=0;i<pairs.length;i++){parentState=pairs[i][0];childState=pairs[i][1];isDefaultSubstate=pairs[i][2];if(!this.state(parentState)){console.warn('State '+parentState+' is not included in the tree. State not added.');return;}
if(this.state(childState)){console.warn('State '+childState+' is already defined. New state not added.');}
this.state(childState,{context:{},defaultSubstate:null,parent:parentState});if(isDefaultSubstate){if(this.state(parentState).defaultSubstate){console.warn('State '+parentState+' already has a default substate '+this.state(parentState).defaultSubstate+' which will be overwritten with '+childState);}
this.state(parentState).defaultSubstate=childState;}}}else if(typeof stateConnection==='object'){for(i in stateConnection){if(stateConnection.hasOwnProperty(i)){this.add(i+" -> "+stateConnection[i]);}}}}
return this;},act:function(){this.context=this._act(this.current,arguments);return this;},_act:function(state,args){this.context=this.state(state).context;var action=this.context[args[0]];if(this._isFunc(action)&&action.apply(this,Array.prototype.slice.call(args,1))===false)return;var parentState=this.state(state).parent;if(parentState)this._act(parentState,args);return this.context;},when:function(stateString,actions){var i;if(typeof stateString==='object'){for(i in stateString){this.when(i,stateString[i]);}}else{var states=stateString.split(/\s+/);for(i=0;i<states.length;i++){var stateName=states[i];if(stateName){var state=this.state(stateName);if(!state){console.warn('State '+stateName+' doesn\'t exist. Actions not added.');return;}
if(this._isFunc(actions)){actions={stay:actions};}
if(!state.context)state.context={};for(i in actions){if(actions.hasOwnProperty(i))state.context[i]=actions[i];}}}}
return this;},whenIn:function(){console.info('Deprecated: Use when() instead of whenIn()');return this.when.apply(this,arguments);},goTo:function(){console.info('Deprecated: Use go() instead of goTo()');return this.go.apply(this,arguments);}};AppSeeds.PubSub={create:function(){var C=function(){};C.prototype=this;var ps=new C();ps._pubsubEvents={};return ps;},pub:function(eventString){var eventComponents=this._parseEventNamespace(eventString);var eventArray,j,args,subscriber,ret,event;for(var i=0;i<eventComponents.length;i++){event=eventComponents[i];eventArray=this._pubsubEvents[event];if(eventArray){args=Array.prototype.slice.call(arguments,1);for(j=0;j<eventArray.length;j++){subscriber=eventArray[j];ret=subscriber[0].apply(subscriber[1]||this,args);if(subscriber[2]&&ret!==false){this.unsub(event,subscriber[0]);}}}}
return this;},_parseEventNamespace:function(event){var events=[],str='',ch;for(var i=0;i<event.length;i++){if((ch=event.charAt(i))===':')events.push(str);str+=ch;}
events.push(str);return events;},sub:function(eventStr,method,thisArg,isOnce){var events=eventStr.split(/\s+/),event,eventArray,i;for(i=0;i<events.length;i++){event=events[i];eventArray=this._pubsubEvents[event];if(eventArray){eventArray.push([method,thisArg,isOnce]);}else{this._pubsubEvents[event]=[[method,thisArg,isOnce]];}}
return this;},unsub:function(eventStr,method){var events=eventStr.split(/\s+/),event,eventArray,i;var f=function(item){return item[0]!==method;};for(i=0;i<events.length;i++){event=events[i];this._pubsubEvents[event]=this._pubsubEvents[event].filter(f);}
return this;},once:function(eventStr,method,thisArg){return this.sub(eventStr,method,thisArg,true);},schedule:function(){return AppSeeds.Scheduler.create(this.pub,arguments,this);}};AppSeeds.Scheduler={create:function(callback,args,thisArg){var C=function(){};C.prototype=this;var schedule=new C();schedule.callback=callback;schedule.args=args||[];schedule.thisArg=thisArg||this;schedule.timeout=null;schedule.interval=null;schedule._timerId=null;return schedule;},now:function(){this.callback.apply(this.thisArg,this.args);return this;},reset:function(){this.stop();if(this.timeout){this.delay(this.timeout);}else if(this.interval){this.repeat(this.interval);}
return this;},delay:function(timeout){var that=this;this.timeout=timeout;this.interval=null;this._timerId=window.setTimeout(function(){that.now();},timeout);return this;},repeat:function(interval){var that=this;this.interval=interval;this.timeout=null;this._timerId=window.setInterval(function(){that.now();},interval);return this;},stop:function(){if(this.timeout){window.clearTimeout(this._timerId);}else if(this.interval){window.clearInterval(this._timerId);}
return this;},destroy:function(){}};AppSeeds.Permit={create:function(options){var sm=AppSeeds.StateManager.create('APPSEEDS_UNAUTH_STATE');var permit={allow:function(roleStr,originalFunction){var roles=roleStr.split(/\s+/),i;if(typeof originalFunction==='function'){var disallow=function(thisArg,args){AppSeeds.delegate.apply(permit,['didDisallow'].concat(Array.prototype.slice.call(args)));return false;};var allow=function(thisArg,args){AppSeeds.delegate.apply(permit,['didAllow'].concat(Array.prototype.slice.call(args)));return true;};var stateChartAction=function(thisArg,args){originalFunction.apply(thisArg,args);};var functionId=AppSeeds.guid();var f=function(){sm.act(functionId,this,arguments);};var obj={};obj[functionId]=stateChartAction;sm.when(sm.root,obj);obj[functionId]=disallow;for(i in sm._states){if(sm._states.hasOwnProperty(i)&&i!==sm.root)sm.when(i,obj);}
obj[functionId]=allow;for(i=0;i<roles.length;i++){if(!sm.state(roles[i]))sm.add(roles[i]);sm.when(roles[i],obj);}
return f;}
return null;},auth:function(role){if(!sm.state(role)){var disallow=function(thisArg,args){AppSeeds.delegate.apply(permit,['didDisallow'].concat(Array.prototype.slice(args)));return false;};var disallowAll={},rootContext=sm.state(sm.root).context;for(var i in rootContext){if(rootContext.hasOwnProperty(i))disallowAll[i]=disallow;}
sm.add(role).when(role,disallowAll);}
sm.go(role);}};if(typeof options==='object')Seeds.extend(permit,options);return permit;}};AppSeeds.delegate=function(){var delegate=this.delegate||this;return typeof delegate[arguments[0]]==='function'?delegate[arguments[0]].apply(this,Array.prototype.slice.call(arguments,1)):true;};AppSeeds.guid=function(){var S4=function(){return(((1+Math.random())*0x10000)|0).toString(16).substring(1);};return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());};AppSeeds.extend=function(){var obj=arguments[0];for(var i=1;i<arguments.length;i++){var ext=arguments[i];for(var j in ext){if(ext.hasOwnProperty(j))obj[j]=ext[j];}}};})(this);