(function(){var a=this,b,c;typeof exports!="undefined"?b=c=exports:b=c=a.AppSeeds=a.Seeds={},c.version="0.7.0",Array.isArray||(Array.isArray=function(a){return Object.prototype.toString.call(a)==="[object Array]"}),Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b,c){for(c=this.length,b=(c+~~b)%c;b<c&&(!(b in this)||this[b]!==a);b++);return b^c?b:-1}),c.StateManager=c.SM={create:function(a){var b=c.o.beget(this._instanceMethods),d=c.o.facade(c.PS.create(),c.PS.PUBLIC_API,b);return c.o.mixin(b,d,{_status:c.StateManager.STATUS_READY,root:"root",_states:{},_actions:{},_queue:{}}),b.state(b.root,{parent:null,context:{},defaultSubstate:null}),b.context=b.state(b.root).context,b.current=b.root,a=a||{},(typeof a=="string"||Array.isArray(a))&&b.add(a),b},STATUS_READY:1,STATUS_TRANSITIONING:2,STATUS_ASYNC:3,ASYNC:!1,_instanceMethods:{root:"root",current:null,_states:{},context:null,_status:null,_queue:null,state:function(a,b){return b!==undefined&&(this._states[a]=b),this._states[a]},children:function(a){var b=[];for(var c in this._states)this._states.hasOwnProperty(c)&&this._states[c].parent===a&&b.push(c);return b},_toRoot:function(a){var b=[];while(a)b.push(a),a=this.state(a).parent;return b},_lca:function(a,b){var c=this._toRoot(a),d=this._toRoot(b),e;for(var f=0;f<c.length;f++){var g=d.indexOf(c[f]);if(g!==-1){e=c[f],c=c.slice(0,f),d=d.slice(0,g).reverse();break}}return{exits:c,entries:d,lca:e}},_getStatePairs:function(a){var b=a.split("->"),c,d;switch(b.length){case 0:d=[];break;case 1:c=this.root,d=b[0].split(/\s+/);break;case 2:c=b[0].replace(/^\s\s*/,"").replace(/\s\s*$/,""),d=b[1].split(/\s+/);break;default:this.pub("error","String "+a+" is an invalid state pair and has been dropped."),d=[]}var e=[],f,g=/^!/;for(var h=0;h<d.length;h++)d[h]&&e.push([c,d[h].replace(g,""),g.test(d[h])]);return e},go:function(a){var b=this.state(a);if(b===undefined){this.pub("error","State "+a+" not defined");return}if(this.current!==a&&this._status===c.SM.STATUS_READY){var d=this._lca(this.current,a);this._walk(d)}return this},_walk:function(a){var b,d;this._status=c.SM.STATUS_TRANSITIONING;for(b=0;b<a.exits.length;b++){this.current=a.exits[b],this.context=this.state(a.exits[b]).context;if(typeof this.context.exit=="function"&&this.context.exit.call(this)===c.SM.ASYNC)return this._status=c.SM.STATUS_ASYNC,this._queue={exits:a.exits.slice(b+1),entries:a.entries,lca:a.lca},this;this.pub("exit",this.current)}this.current=a.lca,this.context=this.state(this.current).context;for(b=0;b<a.entries.length;b++){this.current=a.entries[b],this.context=this.state(a.entries[b]).context;if(typeof this.context.enter=="function"&&this.context.enter.call(this)===c.SM.ASYNC)return this._status=c.SM.STATUS_ASYNC,this._queue={exits:[],entries:a.entries.slice(b+1),lca:a.entries[b]},this;this.pub("enter",this.current)}this._status=c.SM.STATUS_READY;var e=this.state(this.current).defaultSubstate;e?this.go(e):(typeof this.context.stay=="function"&&this.context.stay.call(this),this.pub("stay",this.current))},resume:function(){this._status===c.SM.STATUS_ASYNC?this._walk(this._queue):this.pub("error","State manager is not paused.")},add:function(a){var b,c,d,e;if(arguments.length>1)for(b=0;b<arguments.length;b++)this.add(arguments[b]);else if(Array.isArray(a))for(b=0;b<a.length;b++)this.add(a[b]);else if(typeof a=="string"){var f=this._getStatePairs(a);for(b=0;b<f.length;b++){c=f[b][0],d=f[b][1],e=f[b][2];if(!this.state(c)){this.pub("error","State "+c+" is not included in the tree. State not added.");return}this.state(d)&&this.pub("error","State "+d+" is already defined. New state not added."),this.state(d,{context:{},defaultSubstate:null,parent:c}),e&&(this.state(c).defaultSubstate&&this.pub("error","State "+c+" already has a default substate "+this.state(c).defaultSubstate+" which will be overwritten with "+d),this.state(c).defaultSubstate=d)}}else if(typeof a=="object")for(b in a)a.hasOwnProperty(b)&&this.add(b+" -> "+a[b]);return this},act:function(){return this._status!==c.SM.ASYNC?this.context=this._act(this.current,arguments):this.pub("error","State manager is paused, can't perform action "+arguments[0]),this},action:function(a){var b=this;return this._actions[a]||(this._actions[a]=function(){return b.act.apply(b,[a].concat(Array.prototype.slice.call(arguments)))}),this._actions[a]},_act:function(a,b){this.context=this.state(a).context;var c=this.context[b[0]];if(typeof c=="function"){var d=c.apply(this,Array.prototype.slice.call(b,1));this.pub("act",b[0],a);if(d===!1)return}var e=this.state(a).parent;return e&&this._act(e,b),this.context},when:function(a,b,c){var d;if(typeof a=="object")for(d in a)this.when(d,a[d]);else{var e=a.split(/\s+/);for(d=0;d<e.length;d++){var f=e[d];if(f){var g=this.state(f);if(!g){this.pub("error","State "+f+" doesn't exist. Actions not added.");return}if(typeof b=="function")b={stay:b};else if(typeof b=="string"){var h=b;b={},b[h]=c}g.context||(g.context={});for(d in b)b.hasOwnProperty(d)&&(g.context[d]=b[d])}}}return this}}},c.PubSub=c.PS={create:function(a){var b=c.o.beget(this._instanceMethods);return c.o.mixin(b,a,{_pubsubEvents:{},_pubsubHappened:{}}),b},_instanceMethods:{pub:function(a){var b=this._parseEventNamespace(a),c,d,e,f,g,h,i,j,k;for(d=0,e=b.length;d<e;d++){c=this._pubsubEvents[k=b[d]]||[],h=Array.prototype.slice.call(arguments,1);for(f=0,g=c.length;f<g;f++)i=c[f],j=i[0].apply(i[1]||this,h),i[2]&&j!==!1&&this.unsub(k,i[0]);this._pubsubHappened[k]=h}return this},_parseEventNamespace:function(a){var b=[],c="",d;for(var e=0;e<a.length;e++)(d=a.charAt(e))===":"&&b.push(c),c+=d;return b.push(c),b},sub:function(a,b,c,d){var e=a.split(/\s+/),f,g,h,i,j;d=d||{once:!1,recoup:!1};for(h=0,i=e.length;h<i;h++)g=this._pubsubEvents[f=e[h]],g?g.push([b,c,d.once]):this._pubsubEvents[f]=[[b,c,d.once]],d.recoup&&(j=this._pubsubHappened[f])&&b.apply(c||this,j);return this},unsub:function(a,b){var c=a.split(/\s+/),d,e,f,g,h;for(g=0;g<c.length;g++){e=this._pubsubEvents[d=c[g]],f=[];for(h=0;h<e.length;h++)e[h][0]!==b&&f.push(e[h]);this._pubsubEvents[d]=f}return this},once:function(a,b,c){return this.sub(a,b,c,{once:!0})},recoup:function(a,b,c){return this.sub(a,b,c,{recoup:!0})},schedule:function(){return c.Scheduler?c.Scheduler.create.apply(c.Scheduler,[this.pub,this].concat(Array.prototype.slice.call(arguments))):null}},PUBLIC_API:["pub","sub","unsub","once","recoup"]},c.Scheduler=c.Sked={create:function(a,b){var d=c.o.beget(this._instanceMethods);return c.o.mixin(d,{callback:a,args:Array.prototype.slice.call(arguments,2),thisArg:b||this,timeout:null,interval:null,limit:null,_lastCalled:(new Date).getTime(),_timerId:null}),d},_instanceMethods:{now:function(){var a=(new Date).getTime();if(!this.limit||a-this._lastCalled>this.limit)this.callback.apply(this.thisArg,arguments.length?arguments:this.args),this._lastCalled=a;return this},throttle:function(a){return this.limit=a,this},reset:function(){return this.stop(),this.timeout?this.delay(this.timeout):this.interval&&this.repeat(this.interval),this},delay:function(a){var b=this;return this.timeout=a,this.interval=null,this._timerId=window.setTimeout(function(){b.now()},a),this},repeat:function(a){var b=this;return this.interval=a,this.timeout=null,this._timerId=window.setInterval(function(){b.now()},a),this},stop:function(){return this.timeout?window.clearTimeout(this._timerId):this.interval&&window.clearInterval(this._timerId),this}},throttled:function(a,b){var d=c.Scheduler.create(a).throttle(b);return function(){d.now()}},delayed:function(a,b){var d=c.Scheduler.create(a).delay(b).stop();return function(){d.reset()}}},c.Permit={create:function(a,b){var d=c.o.beget(this._instanceMethods),e=c.o.facade(c.PS.create(),c.PS.PUBLIC_API,d);return c.o.mixin(d,e,{_functions:{},_evaluator:function(a){return a},_thisArg:this}),typeof a!==undefined&&d.evaluator(a,b),d},_instanceMethods:{_isAllowed:function(a){return typeof this._evaluator=="string"?a===this._evaluator:typeof this._evaluator=="function"?this._evaluator.call(this._thisArg,a):this._evaluator instanceof RegExp?this._evaluator.test(a):!1},allow:function(a,b){var d,e;if(typeof b=="function"){for(d in this._functions)if(this._functions.hasOwnProperty(d)&&this._functions[d].func===b){e=d;break}e||(this._functions[e=c.o.guid()]={func:b,expr:a});var f=this._functions[e],g=this;return f.locked=function(){if(g._isAllowed(f.expr)){var a=f.func.apply(this,arguments);return g.pub("allow",f.locked,Array.prototype.slice.call(arguments)),a}g.pub("disallow",f.locked,Array.prototype.slice.call(arguments))},f.locked}return null},evaluator:function(a,b){return this._evaluator=a,b!==undefined&&(this._thisArg=b),this}}},c.o={guid:function(){var a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},mixin:function(){var a=arguments[0];for(var b=1;b<arguments.length;b++){var c=arguments[b];if(c)for(var d in c)c.hasOwnProperty(d)&&(a[d]=c[d])}return a},beget:function(a){var b=function(){};return b.prototype=a,new b},facade:function(a,b,d){var e={},f;if(Array.isArray(b))for(f=0;f<b.length;f++)e[b[f]]=c.o.bind(a,b[f],d||e);else if(typeof b=="object")for(f in b)b.hasOwnProperty(f)&&(e[b[f]]=c.o.bind(a,f,d||e));return e},bind:function(a,b,c){return function(){var d=a[b].apply(a,arguments);return d===a?c:d}}},c.f={}})(this);